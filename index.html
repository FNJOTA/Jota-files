<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuepajaFiles - Gestor de Archivos Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .user-section {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #81d4fa;
        }

        .user-section h3 {
            color: #0277bd;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-input {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-input input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #81d4fa;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .user-input input:focus {
            outline: none;
            border-color: #0277bd;
            box-shadow: 0 0 0 3px rgba(2, 119, 189, 0.1);
        }

        .current-user {
            background: #0277bd;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .setup-section {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .setup-section h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            position: relative;
        }

        .input-field input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-field input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-field label {
            position: absolute;
            top: -8px;
            left: 16px;
            background: white;
            padding: 0 8px;
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .connect-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .upload-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #64748b;
            font-size: 1rem;
        }

        .file-input {
            display: none;
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-section h4 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .category-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .category-btn:hover, .category-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .category-btn .icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .category-btn .name {
            font-weight: 600;
            color: #1e293b;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .file-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .file-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-icon {
            font-size: 2rem;
            margin-right: 15px;
            color: #667eea;
        }

        .file-details h5 {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .file-user {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            color: #0277bd;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 5px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn {
            background: #10b981;
            color: white;
        }

        .download-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: #374151;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stats-label {
            color: #6b7280;
            font-size: 1rem;
        }

        .sql-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }

        .warning-box {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .warning-box p {
            color: #78350f;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .input-group {
                grid-template-columns: 1fr;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .user-input {
                flex-direction: column;
                align-items: stretch;
            }

            .user-input input {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö QuepajaFiles</h1>
            <p>espacio para organizar archivos del inacap mas facil :]</p>
            <p>Ocupen la wea bien amikos porfavor</p>
        </div>

        <div class="setup-section" id="setupSection">
            <h3>üöÄ Iniciando Conexi√≥n...</h3>
            <div style="text-align: center; padding: 40px;">
                <div class="loading" style="margin: 0 auto 20px;"></div>
                <p style="color: #6b7280; font-size: 1.1rem;" id="loadingText">Conectando con tu base de datos...</p>
            </div>
            <div id="connectionStatus"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="user-section">
                <h3>üë§ Identificaci√≥n de Usuario</h3>
                <p>Porfavor ingresar tu nombre para identificar tus archivos</p>
                <div class="user-input">
                    <input type="text" id="userNameInput" placeholder="Tu nombre (ej: Juan P√©rez)" />
                    <div class="current-user" id="currentUser">
                        üë§ Sin identificar
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <div class="stats-number" id="totalFiles">0</div>
                <div class="stats-label">archivos guardados</div>
            </div>

            <div class="category-section">
                <h4>üìÅ Selecciona una categor√≠a para tus archivos</h4>
                <div class="category-grid">
                    <div class="category-btn" data-category="apuntes" onclick="selectCategory(this)">
                        <div class="icon">üìù</div>
                        <div class="name">Apuntes</div>
                    </div>
                    <div class="category-btn" data-category="codigo" onclick="selectCategory(this)">
                    <div class="icon">üíª</div>
                    <div class="name">C√≥digo</div>
                    </div>
                    <div class="category-btn" data-category="examenes" onclick="selectCategory(this)">
                        <div class="icon">üìã</div>
                        <div class="name">Ex√°menes</div>
                    </div>
                    <div class="category-btn" data-category="trabajos" onclick="selectCategory(this)">
                        <div class="icon">üìÑ</div>
                        <div class="name">Trabajos</div>
                    </div>
                    <div class="category-btn" data-category="libros" onclick="selectCategory(this)">
                        <div class="icon">üìö</div>
                        <div class="name">Libros</div>
                    </div>
                    <div class="category-btn" data-category="presentaciones" onclick="selectCategory(this)">
                        <div class="icon">üéØ</div>
                        <div class="name">Presentaciones</div>
                    </div>
                    <div class="category-btn" data-category="otros" onclick="selectCategory(this)">
                        <div class="icon">üìÅ</div>
                        <div class="name">Otros</div>
                    </div>
                </div>
            </div>

            <div class="upload-area" id="uploadArea" onclick="triggerFileUpload()">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <div class="upload-text">Arrastra tus archivos aqu√≠ o haz clic para seleccionar</div>
                <div class="upload-subtext">Soporta documentos, c√≥digo, im√°genes y archivos comprimidos</div>
            </div>

            <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.py,.js,.html,.css,.cpp,.c,.java,.json,.xml,.sql,.md,.yml,.yaml,.php,.rb,.go,.ts,.jsx,.tsx,.vue,.swift,.kt,.dart,.r,.m,.sh,.bat,.ps1,.csv,.zip,.rar,.7z">

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="files-grid" id="filesGrid"></div>
        </div>
    </div>

    <script>
        // üîß CONFIGURACI√ìN DE SUPABASE - EDITA AQU√ç TUS CREDENCIALES
        const SUPABASE_CONFIG = {
            url: 'https://rdclvldnpjudgokhrasr.supabase.co', // Tu URL de Supabase
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkY2x2bGRucGp1ZGdva2hyYXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDIwNzMsImV4cCI6MjA2NDU3ODA3M30.zvHLeUzARWGjlymIBpfjfPO7fixpVcYBhlAkJjLXv5Y' // Tu clave p√∫blica (anon key)
        };

        let supabase = null;
        let selectedCategory = 'apuntes';
        let files = [];
        let debugMode = true; // Activar debug
        let currentUser = '';

        // Auto-conectar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('[data-category="apuntes"]').classList.add('selected');
            setupUserInput();
            setTimeout(autoConnectSupabase, 1000);
        });

        // Configurar entrada de usuario
        function setupUserInput() {
            const userInput = document.getElementById('userNameInput');
            const currentUserDiv = document.getElementById('currentUser');
            
            // Cargar usuario guardado
            const savedUser = localStorage.getItem('jotafiles_user');
            if (savedUser) {
                currentUser = savedUser;
                userInput.value = savedUser;
                updateUserDisplay();
            }
            
            userInput.addEventListener('input', (e) => {
                currentUser = e.target.value.trim();
                if (currentUser) {
                    localStorage.setItem('jotafiles_user', currentUser);
                } else {
                    localStorage.removeItem('jotafiles_user');
                }
                updateUserDisplay();
            });
        }

        function updateUserDisplay() {
            const currentUserDiv = document.getElementById('currentUser');
            if (currentUser) {
                currentUserDiv.innerHTML = `üë§ ${currentUser}`;
                currentUserDiv.style.background = '#0277bd';
            } else {
                currentUserDiv.innerHTML = 'üë§ Sin identificar';
                currentUserDiv.style.background = '#6b7280';
            }
        }

        function triggerFileUpload() {
            if (!currentUser) {
                alert('Por favor, identif√≠cate con tu nombre antes de subir archivos');
                document.getElementById('userNameInput').focus();
                return;
            }
            document.getElementById('fileInput').click();
        }

        // Funci√≥n de debug
        function debugLog(message, data = null) {
            if (!debugMode) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = 'block';
            
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            debugDiv.innerHTML += logEntry + '\n\n';
            debugDiv.scrollTop = debugDiv.scrollHeight;
            
            console.log(`[UniFiles Debug] ${message}`, data || '');
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        // Configurar eventos de drag and drop
        const setupDragAndDrop = () => {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if (!currentUser) {
                    alert('Por favor, identif√≠cate con tu nombre antes de subir archivos');
                    document.getElementById('userNameInput').focus();
                    return;
                }
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        };

        async function autoConnectSupabase() {
            try {
                debugLog('Iniciando proceso de conexi√≥n...');
                updateLoadingText('Verificando configuraci√≥n...');

                // Verificar que Supabase SDK est√© cargado
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK no est√° disponible');
                }
                debugLog('‚úÖ Supabase SDK cargado correctamente');

                // Validar configuraci√≥n
                if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
                    throw new Error('Configuraci√≥n incompleta');
                }

                if (!SUPABASE_CONFIG.url.startsWith('https://') || !SUPABASE_CONFIG.url.includes('.supabase.co')) {
                    throw new Error('URL de Supabase inv√°lida');
                }

                if (!SUPABASE_CONFIG.anonKey.startsWith('eyJ') || SUPABASE_CONFIG.anonKey.length < 100) {
                    throw new Error('Clave p√∫blica inv√°lida');
                }

                debugLog('‚úÖ Configuraci√≥n v√°lida', {
                    url: SUPABASE_CONFIG.url,
                    keyLength: SUPABASE_CONFIG.anonKey.length
                });

                updateLoadingText('Conectando con Supabase...');
                
                // Inicializar cliente con timeout
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout en inicializaci√≥n')), 10000);
                });

                const initPromise = Promise.resolve().then(() => {
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    return supabase;
                });

                await Promise.race([initPromise, timeoutPromise]);
                debugLog('‚úÖ Cliente Supabase inicializado');

                updateLoadingText('Verificando conectividad...');
                
                // Test b√°sico de conectividad con timeout m√°s corto
                const connectivityTest = async () => {
                    const { data, error } = await supabase.from('files').select('count').limit(1);
                    return { data, error };
                };

                const connectivityTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout verificando conectividad')), 8000);
                });

                const { data: connectivityData, error: connectivityError } = await Promise.race([
                    connectivityTest(),
                    connectivityTimeout
                ]);

                debugLog('Test de conectividad completado', { 
                    error: connectivityError ? connectivityError.message : null,
                    data: connectivityData 
                });

                if (connectivityError) {
                    if (connectivityError.code === 'PGRST116' || connectivityError.message.includes('does not exist')) {
                        debugLog('‚ö†Ô∏è Tabla "files" no existe o tiene estructura incorrecta');
                        showTableInstructions();
                        return;
                    } else if (connectivityError.message.includes('column') && connectivityError.message.includes('does not exist')) {
                        debugLog('‚ö†Ô∏è Estructura de tabla incorrecta');
                        showTableInstructions();
                        return;
                    } else if (connectivityError.message.includes('Failed to fetch')) {
                        throw new Error('No se puede conectar al servidor. Verifica tu URL.');
                    } else if (connectivityError.message.includes('Invalid API key')) {
                        throw new Error('Clave de API inv√°lida. Verifica tu anon key.');
                    } else {
                        throw connectivityError;
                    }
                }

                debugLog('‚úÖ Conectividad verificada');
                updateLoadingText('Verificando almacenamiento...');

                // Verificar storage con timeout
                const storageTest = async () => {
                    const { data: buckets, error } = await supabase.storage.listBuckets();
                    return { buckets, error };
                };

                const storageTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout verificando storage')), 5000);
                });

                const { buckets, error: bucketsError } = await Promise.race([
                    storageTest(),
                    storageTimeout
                ]);

                if (bucketsError) {
                    debugLog('‚ö†Ô∏è Error en storage:', bucketsError);
                    // No es cr√≠tico, continuamos
                } else {
                    debugLog('‚úÖ Storage verificado', { bucketsCount: buckets?.length || 0 });
                }

                // Crear bucket si no existe
                let bucketExists = buckets?.some(bucket => bucket.name === 'university-files');
                
                if (!bucketExists) {
                    updateLoadingText('Configurando almacenamiento...');
                    debugLog('Creando bucket university-files...');
                    
                    const { error: createError } = await supabase.storage.createBucket('university-files', {
                        public: true
                    });
                    
                    if (createError && !createError.message.includes('already exists')) {
                        debugLog('‚ö†Ô∏è Advertencia creando bucket:', createError);
                    } else {
                        debugLog('‚úÖ Bucket configurado');
                    }
                }

                // ¬°Conexi√≥n exitosa!
                debugLog('üéâ Conexi√≥n completada exitosamente');
                showStatus('‚úÖ ¬°Conexi√≥n exitosa! Cargando tu biblioteca...', 'success');
                updateLoadingText('¬°Listo! Cargando interfaz...');
                
                setupDragAndDrop();
                
                setTimeout(() => {
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                    loadFiles();
                }, 2000);

            } catch (error) {
                debugLog('‚ùå Error en conexi√≥n:', error);
                console.error('Error completo:', error);
                
                let errorMessage = error.message;
                let helpText = '';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Timeout')) {errorMessage = 'Error de conexi√≥n con Supabase';
                    helpText = 'Verifica tu conexi√≥n a internet y que la URL de Supabase sea correcta.';
                } else if (error.message.includes('Invalid API key')) {
                    errorMessage = 'Clave de API inv√°lida';
                    helpText = 'Revisa que tu anon key sea correcta y tenga los permisos necesarios.';
                } else if (error.message.includes('Configuraci√≥n incompleta')) {
                    errorMessage = 'Configuraci√≥n incompleta';
                    helpText = 'Aseg√∫rate de configurar tanto la URL como la clave p√∫blica de Supabase.';
                }
                
                showStatus(`‚ùå ${errorMessage}`, 'error');
                updateLoadingText(`Error: ${errorMessage}`);
                
                if (helpText) {
                    document.getElementById('connectionStatus').innerHTML += `<p style="margin-top: 10px; color: #6b7280;">${helpText}</p>`;
                }
            }
        }

        function showTableInstructions() {
            const setupSection = document.getElementById('setupSection');
            setupSection.innerHTML = `
                <div class="warning-box">
                    <h4>‚ö†Ô∏è Configuraci√≥n de Base de Datos Requerida</h4>
                    <p>Para usar JotaFiles, necesitas crear una tabla en tu base de datos de Supabase.</p>
                    <p><strong>Ejecuta este SQL en el Editor SQL de Supabase:</strong></p>
                </div>
                
                <div class="sql-block">CREATE TABLE IF NOT EXISTS files (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    user_name TEXT NOT NULL,
    file_path TEXT,
    file_size BIGINT,
    content_type TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Habilitar Row Level Security (RLS)
ALTER TABLE files ENABLE ROW LEVEL SECURITY;

-- Crear pol√≠tica para permitir todas las operaciones
CREATE POLICY "Allow all operations on files" ON files FOR ALL USING (true);</div>
                
                <div class="warning-box">
                    <h4>üìã Pasos a seguir:</h4>
                    <p>1. Ve a tu panel de Supabase ‚Üí Editor SQL</p>
                    <p>2. Copia y pega el c√≥digo SQL de arriba</p>
                    <p>3. Haz clic en "Run" para ejecutar</p>
                    <p>4. Recarga esta p√°gina</p>
                </div>
                
                <button class="connect-btn" onclick="location.reload()" style="margin-top: 20px;">
                    üîÑ Recargar P√°gina
                </button>
            `;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function selectCategory(element) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Seleccionar nueva categor√≠a
            element.classList.add('selected');
            selectedCategory = element.dataset.category;
            
            debugLog(`Categor√≠a seleccionada: ${selectedCategory}`);
        }

        async function handleFiles(fileList) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            
            const totalFiles = fileList.length;
            let completedFiles = 0;

            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                
                try {
                    await uploadFile(file);
                    completedFiles++;
                    
                    const progress = (completedFiles / totalFiles) * 100;
                    progressFill.style.width = `${progress}%`;
                    
                } catch (error) {
                    debugLog(`Error subiendo ${file.name}:`, error);
                    alert(`Error subiendo ${file.name}: ${error.message}`);
                }
            }
            
            // Ocultar barra de progreso
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 1000);
            
            // Recargar lista de archivos
            await loadFiles();
        }

        async function uploadFile(file) {
            try {
                debugLog(`Iniciando subida de: ${file.name}`);
                
                // Generar nombre √∫nico para el archivo
                const timestamp = Date.now();
                const randomString = Math.random().toString(36).substring(2, 8);
                const fileExtension = file.name.split('.').pop();
                const uniqueFileName = `${currentUser}_${selectedCategory}_${timestamp}_${randomString}.${fileExtension}`;
                
                // Subir archivo al storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('university-files')
                    .upload(`${selectedCategory}/${uniqueFileName}`, file);
                
                if (uploadError) {
                    throw uploadError;
                }
                
                debugLog(`Archivo subido al storage: ${uploadData.path}`);
                
                // Guardar informaci√≥n en la base de datos
                const { data: dbData, error: dbError } = await supabase
                    .from('files')
                    .insert([
                        {
                            name: file.name,
                            category: selectedCategory,
                            user_name: currentUser,
                            file_path: uploadData.path,
                            file_size: file.size,
                            content_type: file.type || 'application/octet-stream'
                        }
                    ])
                    .select();
                
                if (dbError) {
                    // Si falla la DB, intentar eliminar el archivo del storage
                    await supabase.storage
                        .from('university-files')
                        .remove([uploadData.path]);
                    throw dbError;
                }
                
                debugLog(`Archivo registrado en DB con ID: ${dbData[0].id}`);
                return dbData[0];
                
            } catch (error) {
                debugLog(`Error en uploadFile para ${file.name}:`, error);
                throw error;
            }
        }

        async function loadFiles() {
            try {
                debugLog('Cargando archivos...');
                
                const { data: filesData, error } = await supabase
                    .from('files')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                files = filesData || [];
                debugLog(`Archivos cargados: ${files.length}`);
                
                updateFilesDisplay();
                updateStats();
                
            } catch (error) {
                debugLog('Error cargando archivos:', error);
                console.error('Error loading files:', error);
            }
        }

        function updateFilesDisplay() {
            const filesGrid = document.getElementById('filesGrid');
            
            if (files.length === 0) {
                filesGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìÅ</div>
                        <h3 style="margin-bottom: 10px; color: #374151;">No hay archivos a√∫n</h3>
                        <p>Sube tu primer archivo para comenzar a organizar tu biblioteca universitaria</p>
                    </div>
                `;
                return;
            }
            
            filesGrid.innerHTML = files.map(file => `
                <div class="file-card">
                    <div class="file-info">
                        <div class="file-icon">${getFileIcon(file.name, file.category)}</div>
                        <div class="file-details">
                            <h5>${file.name}</h5>
                            <p>${formatFileSize(file.file_size)} ‚Ä¢ ${formatDate(file.created_at)}</p>
                            <div class="file-user">üë§ ${file.user_name}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn download-btn" onclick="downloadFile('${file.id}', '${file.file_path}', '${file.name}')">
                            ‚¨áÔ∏è Descargar
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteFile('${file.id}', '${file.file_path}', '${file.name}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(fileName, category) {
            const extension = fileName.split('.').pop().toLowerCase();
            
            // Iconos por categor√≠a
            const categoryIcons = {
                'apuntes': 'üìù',
                'codigo': 'üíª',
                'examenes': 'üìã',
                'trabajos': 'üìÑ',
                'libros': 'üìö',
                'presentaciones': 'üéØ',
                'otros': 'üìÅ'
            };
            
            // Iconos por extensi√≥n
            const extensionIcons = {
                'pdf': 'üìÑ',
                'doc': 'üìù', 'docx': 'üìù',
                'ppt': 'üéØ', 'pptx': 'üéØ',
                'xls': 'üìä', 'xlsx': 'üìä',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è',
                'py': 'üêç', 'js': 'üü®', 'html': 'üåê', 'css': 'üé®',
                'cpp': '‚öôÔ∏è', 'c': '‚öôÔ∏è', 'java': '‚òï',
                'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶',
                'txt': 'üìÑ', 'md': 'üìù'
            };
            
            return extensionIcons[extension] || categoryIcons[category] || 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Hoy';
            } else if (diffDays === 1) {
                return 'Ayer';
            } else if (diffDays < 7) {
                return `Hace ${diffDays} d√≠as`;
            } else {
                return date.toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            }
        }

        function updateStats() {
            const totalFilesElement = document.getElementById('totalFiles');
            totalFilesElement.textContent = files.length;
        }

        async function downloadFile(fileId, filePath, fileName) {
            try {
                debugLog(`Descargando archivo: ${fileName}`);
                
                const { data, error } = await supabase.storage
                    .from('university-files')
                    .download(filePath);
                
                if (error) {
                    throw error;
                }
                
                // Crear URL de descarga
                const url = URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                debugLog(`Archivo descargado: ${fileName}`);
                
            } catch (error) {
                debugLog(`Error descargando ${fileName}:`, error);
                alert(`Error al descargar el archivo: ${error.message}`);
            }
        }

        async function deleteFile(fileId, filePath, fileName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar "${fileName}"?`)) {
                return;
            }
            
            try {
                debugLog(`Eliminando archivo: ${fileName}`);
                
                // Eliminar de la base de datos
                const { error: dbError } = await supabase
                    .from('files')
                    .delete()
                    .eq('id', fileId);
                
                if (dbError) {
                    throw dbError;
                }
                
                // Eliminar del storage
                const { error: storageError } = await supabase.storage
                    .from('university-files')
                    .remove([filePath]);
                
                if (storageError) {
                    debugLog(`Advertencia eliminando del storage:`, storageError);
                    // No es cr√≠tico si falla el storage
                }
                
                debugLog(`Archivo eliminado: ${fileName}`);
                
                // Recargar archivos
                await loadFiles();
                
            } catch (error) {
                debugLog(`Error eliminando ${fileName}:`, error);
                alert(`Error al eliminar el archivo: ${error.message}`);
            }
        }
    </script>
</body>
</html>