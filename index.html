<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PajasFiles - Gestor de Archivos Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: float 20s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-20px, -20px) rotate(180deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 2px;
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 300;
            margin-bottom: 20px;
        }

        .reloj-container {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 12px 24px;
            color: white;
            font-weight: 500;
            font-size: 1rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            animation: fadeIn 1s ease-in-out;
        }

        .reloj-icon {
            font-size: 1.2rem;
            animation: tick 2s infinite;
        }

        @keyframes tick {
            0%, 50%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(6deg); }
            75% { transform: rotate(-6deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .setup-section, .user-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .setup-section h3, .user-section h3 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .user-input {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-input input {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .user-input input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .user-input input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .current-user {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: fit-content;
            white-space: nowrap;
        }

        .upload-section {
            display: none;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-container {
            position: relative;
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .stats-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 500;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 60px 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(15px);
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: rgba(255, 255, 255, 0.8);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 3px 10px rgba(0, 0, 0, 0.3));
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .upload-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            font-weight: 400;
        }

        .file-input {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .file-section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section-icon {
            font-size: 2rem;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
        }

        .section-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .section-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: auto;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .file-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.15));
        }

        .file-info {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .file-icon {
            font-size: 2.2rem;
            margin-right: 15px;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.3));
            flex-shrink: 0;
        }

        .file-details h5 {
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
            font-size: 1rem;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            word-break: break-word;
        }

        .file-details p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .file-user {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(10px);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-family: 'Poppins', sans-serif;
            flex: 1;
        }

        .download-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .delete-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .status.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1));
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1));
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: rgba(255, 255, 255, 0.7);
            grid-column: 1 / -1;
        }

        .empty-state .icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 3px 10px rgba(0, 0, 0, 0.3));
        }

        .empty-state h3 {
            margin-bottom: 12px;
            color: white;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .empty-state p {
            font-size: 1rem;
            max-width: 350px;
            margin: 0 auto;
        }

        .setup-instructions {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.1));
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .setup-instructions h4 {
            margin-bottom: 15px;
            color: #fbbf24;
        }

        .setup-instructions ol {
            padding-left: 20px;
            line-height: 1.6;
        }

        .setup-instructions li {
            margin-bottom: 8px;
        }

        .retry-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            margin-top: 15px;
        }

        .retry-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px 15px;
                margin: 10px;
                border-radius: 20px;
            }

            .header h1 {
                font-size: 2.8rem;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .user-input {
                flex-direction: column;
                align-items: stretch;
            }

            .user-input input {
                min-width: auto;
                margin-bottom: 10px;
            }

            .files-grid {
                grid-template-columns: 1fr;
            }

            .file-actions {
                flex-direction: column;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2.3rem;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="header">
                        <div class="reloj-container">
                <span class="reloj-icon">🕒</span>
                <span id="relojZonaHoraria">Cargando hora...</span>
            </div>
            <h1>PajasFiles</h1>

            <p>Nuestro espacio para organizar archivos</p>
           
        </div>

        <div class="setup-section" id="setupSection">
            <h3>🚀 Iniciando Conexión</h3>
            <div class="loading-container">
                <div class="loading"></div>
                <p class="loading-text" id="loadingText">Conectando con tu base de datos...</p>
                 <p>made in jota</p>
            </div>
            <div id="connectionStatus"></div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="user-section">
                <h3>👤 Identificación de Usuario</h3>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 15px;">Por favor ingresa tu nombre para identificar tus archivos</p>
                <div class="user-input">
                    <input type="text" id="userNameInput" placeholder="Tu nombre (ej: Juan Pérez)" />
                    <div class="current-user" id="currentUser">
                        👤 Sin identificar
                    </div>
                </div>
            </div>

            <div class="stats-cards">
                <div class="stats-card">
                    <div class="stats-number" id="totalFiles">0</div>
                    <div class="stats-label">archivos totales</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalDocuments">0</div>
                    <div class="stats-label">documentos</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalImages">0</div>
                    <div class="stats-label">imágenes</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="totalCode">0</div>
                    <div class="stats-label">código</div>
                </div>
            </div>

            <div class="upload-area" id="uploadArea" onclick="triggerFileUpload()">
                <div class="upload-icon">☁️</div>
                <div class="upload-text">Arrastra tus archivos aquí o haz clic para seleccionar</div>
                <div class="upload-subtext">Soporta documentos, código, imágenes y archivos comprimidos</div>
            </div>

            <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.py,.js,.html,.css,.cpp,.c,.java,.json,.xml,.sql,.md,.yml,.yaml,.php,.rb,.go,.ts,.jsx,.tsx,.vue,.swift,.kt,.dart,.r,.m,.sh,.bat,.ps1,.csv,.zip,.rar,.7z">

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="search-container">
                <div class="search-icon">🔍</div>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar archivos por nombre, tipo o usuario...">
            </div>

            <div id="fileSections"></div>
            
        </div>
    </div>

    <script>
        // 🔧 CONFIGURACIÓN DE SUPABASE - EDITA AQUÍ TUS CREDENCIALES
        const SUPABASE_CONFIG = {
            url: 'https://jptqpjnvdbxwxwafvkes.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwdHFwam52ZGJ4d3h3YWZ2a2VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTU1NTQsImV4cCI6MjA2NDYzMTU1NH0.1_GtFiQ3FE4TyvYCG3OwL2DBl5XWSu-ASAYg76S5LYY',
            bucketName: 'apuntes' // Cambiado de 'files' a 'archivos'
        };

        let supabase = null;
        let selectedCategory = 'apuntes';
        let files = [];
        let filteredFiles = [];
        let currentUser = '';

        // Definir tipos de archivos y sus secciones
        const FILE_TYPES = {
            'documentos': {
                icon: '📄',
                extensions: ['pdf', 'doc', 'docx', 'txt', 'md', 'rtf']
            },
            'presentaciones': {
                icon: '🎯',
                extensions: ['ppt', 'pptx', 'key']
            },
            'hojas-calculo': {
                icon: '📊',
                extensions: ['xls', 'xlsx', 'csv', 'ods']
            },
            'imagenes': {
                icon: '🖼️',
                extensions: ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp']
            },
            'codigo': {
                icon: '💻',
                extensions: ['py', 'js', 'html', 'css', 'cpp', 'c', 'java', 'json', 'xml', 'sql', 'yml', 'yaml', 'php', 'rb', 'go', 'ts', 'jsx', 'tsx', 'vue', 'swift', 'kt', 'dart', 'r', 'm', 'sh', 'bat', 'ps1']
            },
            'comprimidos': {
                icon: '📦',
                extensions: ['zip', 'rar', '7z', 'tar', 'gz']
            },
            'otros': {
                icon: '📁',
                extensions: []
            }
        };

        // Auto-conectar al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            setupUserInput();
            setupSearch();
            updateClock();
            setInterval(updateClock, 1000);
            setTimeout(autoConnectSupabase, 1000);
        });

        // Configurar entrada de usuario
        function setupUserInput() {
            const userInput = document.getElementById('userNameInput');
            const currentUserDiv = document.getElementById('currentUser');
            
            userInput.addEventListener('input', (e) => {
                currentUser = e.target.value.trim();
                updateCurrentUserDisplay();
            });
        }

// Eliminar la línea rota: const currentUserDiv = document.getElementByI
        
        function updateCurrentUserDisplay() {
            const currentUserDiv = document.getElementById('currentUser');
            
            if (currentUser) {
                currentUserDiv.innerHTML = `👤 ${currentUser}`;
                currentUserDiv.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1))';
            } else {
                currentUserDiv.innerHTML = '👤 Sin identificar';
                currentUserDiv.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1))';
            }
        }

        // Configurar búsqueda
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterFiles(searchTerm);
            });
        }

        function filterFiles(searchTerm) {
            if (searchTerm) {
                filteredFiles = files.filter(file => 
                    file.name.toLowerCase().includes(searchTerm) ||
                    file.user.toLowerCase().includes(searchTerm) ||
                    getFileType(file.name).toLowerCase().includes(searchTerm)
                );
            } else {
                filteredFiles = [...files];
            }
            displayFiles();
        }

        // Actualizar reloj
        function updateClock() {
            const now = new Date();
            const options = {
                timeZone: 'America/Santiago',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            
            const formatter = new Intl.DateTimeFormat('es-CL', options);
            const timeString = formatter.format(now);
            
            document.getElementById('relojZonaHoraria').textContent = timeString;
        }

        // Auto-conectar con Supabase
        async function autoConnectSupabase() {
            const setupSection = document.getElementById('setupSection');
            const uploadSection = document.getElementById('uploadSection');
            const loadingText = document.getElementById('loadingText');
            const connectionStatus = document.getElementById('connectionStatus');

            try {
                loadingText.textContent = 'Inicializando Supabase...';
                
                // Inicializar Supabase
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                loadingText.textContent = 'Verificando conexión...';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Verificar conexión
                const { data, error } = await supabase.storage.listBuckets();
                
                if (error) {
                    throw error;
                }
                
                loadingText.textContent = 'Cargando archivos...';
                await loadFiles();
                
                // Conexión exitosa
                connectionStatus.innerHTML = `
                    <div class="status success">
                        ✅ Conectado exitosamente a Supabase
                    </div>
                `;
                
                setTimeout(() => {
                    setupSection.style.display = 'none';
                    uploadSection.style.display = 'block';
                }, 1500);
                
            } catch (error) {
                console.error('Error de conexión:', error);
                connectionStatus.innerHTML = `
                    <div class="status error">
                        ❌ Error de conexión: ${error.message}
                        <button class="retry-btn" onclick="autoConnectSupabase()">Reintentar</button>
                    </div>
                `;
            }
        }

        // Cargar archivos desde Supabase
        async function loadFiles() {
            try {
                const { data, error } = await supabase.storage
                    .from(SUPABASE_CONFIG.bucketName)
                    .list('', {
                        limit: 1000,
                        sortBy: { column: 'created_at', order: 'desc' }
                    });

                if (error) {
                    throw error;
                }

                files = data.map(file => ({
                    ...file,
                    user: extractUserFromFilename(file.name),
                    originalName: extractOriginalName(file.name)
                }));

                filteredFiles = [...files];
                displayFiles();
                updateStats();
                
            } catch (error) {
                console.error('Error cargando archivos:', error);
                showStatus('Error cargando archivos: ' + error.message, 'error');
            }
        }

        function extractUserFromFilename(filename) {
            const match = filename.match(/^(.+?)_\d+_(.+)$/);
            return match ? match[1] : 'Usuario desconocido';
        }

        function extractOriginalName(filename) {
            const match = filename.match(/^.+?_\d+_(.+)$/);
            return match ? match[2] : filename;
        }

        // Mostrar archivos
        function displayFiles() {
            const fileSections = document.getElementById('fileSections');
            
            if (filteredFiles.length === 0) {
                fileSections.innerHTML = `
                    <div class="file-section">
                        <div class="empty-state">
                            <div class="icon">📂</div>
                            <h3>No hay archivos disponibles</h3>
                            <p>Sube tu primer archivo para comenzar a organizar tu contenido</p>
                        </div>
                    </div>
                `;
                return;
            }

            const filesByType = groupFilesByType(filteredFiles);
            let sectionsHTML = '';

            Object.entries(filesByType).forEach(([type, typeFiles]) => {
                if (typeFiles.length > 0) {
                    const typeConfig = FILE_TYPES[type];
                    sectionsHTML += `
                        <div class="file-section">
                            <div class="section-header">
                                <div class="section-icon">${typeConfig.icon}</div>
                                <div class="section-title">${formatSectionTitle(type)}</div>
                                <div class="section-count">${typeFiles.length}</div>
                            </div>
                            <div class="files-grid">
                                ${typeFiles.map(file => createFileCard(file)).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            fileSections.innerHTML = sectionsHTML;
        }

        function groupFilesByType(files) {
            const grouped = {};
            
            // Inicializar grupos
            Object.keys(FILE_TYPES).forEach(type => {
                grouped[type] = [];
            });

            files.forEach(file => {
                const type = getFileType(file.name);
                if (grouped[type]) {
                    grouped[type].push(file);
                } else {
                    grouped['otros'].push(file);
                }
            });

            return grouped;
        }

        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            
            for (const [type, config] of Object.entries(FILE_TYPES)) {
                if (config.extensions.includes(extension)) {
                    return type;
                }
            }
            
            return 'otros';
        }

        function formatSectionTitle(type) {
            const titles = {
                'documentos': 'Documentos',
                'presentaciones': 'Presentaciones',
                'hojas-calculo': 'Hojas de Cálculo',
                'imagenes': 'Imágenes',
                'codigo': 'Código',
                'comprimidos': 'Archivos Comprimidos',
                'otros': 'Otros Archivos'
            };
            return titles[type] || 'Archivos';
        }

        function createFileCard(file) {
            const fileType = getFileType(file.name);
            const icon = FILE_TYPES[fileType].icon;
            const sizeFormatted = formatFileSize(file.metadata?.size || 0);
            const dateFormatted = formatDate(file.created_at);

            return `
                <div class="file-card" onclick="downloadFile('${file.name}')">
                    <div class="file-info">
                        <div class="file-icon">${icon}</div>
                        <div class="file-details">
                            <h5>${file.originalName}</h5>
                            <p>Tamaño: ${sizeFormatted}</p>
                            <p>Subido: ${dateFormatted}</p>
                            <div class="file-user">
                                👤 ${file.user}
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn download-btn" onclick="event.stopPropagation(); downloadFile('${file.name}')">
                            ⬇️ Descargar
                        </button>
                        <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteFile('${file.name}')">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Actualizar estadísticas
        function updateStats() {
            const stats = {
                total: files.length,
                documentos: 0,
                imagenes: 0,
                codigo: 0
            };

            files.forEach(file => {
                const type = getFileType(file.name);
                if (type === 'documentos' || type === 'presentaciones' || type === 'hojas-calculo') {
                    stats.documentos++;
                } else if (type === 'imagenes') {
                    stats.imagenes++;
                } else if (type === 'codigo') {
                    stats.codigo++;
                }
            });

            document.getElementById('totalFiles').textContent = stats.total;
            document.getElementById('totalDocuments').textContent = stats.documentos;
            document.getElementById('totalImages').textContent = stats.imagenes;
            document.getElementById('totalCode').textContent = stats.codigo;
        }

        // Funciones de archivos
        function triggerFileUpload() {
            if (!currentUser) {
                showStatus('Por favor ingresa tu nombre antes de subir archivos', 'error');
                document.getElementById('userNameInput').focus();
                return;
            }
            document.getElementById('fileInput').click();
        }

        // Configurar drag & drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            if (!currentUser) {
                showStatus('Por favor ingresa tu nombre antes de subir archivos', 'error');
                document.getElementById('userNameInput').focus();
                return;
            }
            
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        });

        async function uploadFiles(files) {
            if (files.length === 0) return;

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            
            let uploadedCount = 0;
            const totalFiles = files.length;

            for (const file of files) {
                try {
                    const timestamp = Date.now();
                    const fileName = `${currentUser}_${timestamp}_${file.name}`;
                    
                    const { data, error } = await supabase.storage
                        .from(SUPABASE_CONFIG.bucketName)
                        .upload(fileName, file);

                    if (error) {
                        throw error;
                    }

                    uploadedCount++;
                    const progress = (uploadedCount / totalFiles) * 100;
                    progressFill.style.width = progress + '%';
                    
                } catch (error) {
                    console.error('Error subiendo archivo:', error);
                    showStatus(`Error subiendo ${file.name}: ${error.message}`, 'error');
                }
            }

            progressBar.style.display = 'none';
            
            if (uploadedCount > 0) {
                showStatus(`${uploadedCount} archivo(s) subido(s) exitosamente`, 'success');
                await loadFiles();
            }
            
            // Limpiar input
            fileInput.value = '';
        }

        async function downloadFile(fileName) {
            try {
                const { data, error } = await supabase.storage
                    .from(SUPABASE_CONFIG.bucketName)
                    .download(fileName);

                if (error) {
                    throw error;
                }

                // Crear enlace de descarga
                const url = URL.createObjectURL(data);
                const link = document.createElement('a');
                link.href = url;
                
                // Usar el nombre original del archivo
                const originalName = extractOriginalName(fileName);
                link.download = originalName;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showStatus('Archivo descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error descargando archivo:', error);
                showStatus('Error descargando archivo: ' + error.message, 'error');
            }
        }

        async function deleteFile(fileName) {
            if (!confirm('¿Estás seguro de que quieres eliminar este archivo?')) {
                return;
            }

            try {
                const { error } = await supabase.storage
                    .from(SUPABASE_CONFIG.bucketName)
                    .remove([fileName]);

                if (error) {
                    throw error;
                }

                showStatus('Archivo eliminado exitosamente', 'success');
                await loadFiles();
                
            } catch (error) {
                console.error('Error eliminando archivo:', error);
                showStatus('Error eliminando archivo: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            // Insertar después del área de upload
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.parentNode.insertBefore(statusDiv, uploadArea.nextSibling);
            
            // Remover después de 5 segundos
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
