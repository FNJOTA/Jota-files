<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JotaFiles - Gestor de Archivos Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .setup-section {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .setup-section h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            position: relative;
        }

        .input-field input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-field input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-field label {
            position: absolute;
            top: -8px;
            left: 16px;
            background: white;
            padding: 0 8px;
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .connect-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .upload-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #64748b;
            font-size: 1rem;
        }

        .file-input {
            display: none;
        }

        .category-section {
            margin-bottom: 30px;
        }

        .category-section h4 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .category-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .category-btn:hover, .category-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .category-btn .icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .category-btn .name {
            font-weight: 600;
            color: #1e293b;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .file-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .file-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-icon {
            font-size: 2rem;
            margin-right: 15px;
            color: #667eea;
        }

        .file-details h5 {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .file-details p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn {
            background: #10b981;
            color: white;
        }

        .download-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: #374151;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stats-label {
            color: #6b7280;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .input-group {
                grid-template-columns: 1fr;
            }

            .upload-area {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Jotafiles</h1>
            <p>Tu espacio personal para organizar todos tus archivos universitarios</p>
        </div>

        <div class="setup-section" id="setupSection">
            <h3>üöÄ Iniciando Conexi√≥n...</h3>
            <div style="text-align: center; padding: 40px;">
                <div class="loading" style="margin: 0 auto 20px;"></div>
                <p style="color: #6b7280; font-size: 1.1rem;" id="loadingText">Conectando con tu base de datos...</p>
            </div>
            <div id="connectionStatus"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="stats-card">
                <div class="stats-number" id="totalFiles">0</div>
                <div class="stats-label">archivos guardados</div>
            </div>

            <div class="category-section">
                <h4>üìÅ Selecciona una categor√≠a para tus archivos</h4>
                <div class="category-grid">
                    <div class="category-btn" data-category="apuntes" onclick="selectCategory(this)">
                        <div class="icon">üìù</div>
                        <div class="name">Apuntes</div>
                    </div>
                    <div class="category-btn" data-category="codigo" onclick="selectCategory(this)">
                    <div class="icon">üíª</div>
                    <div class="name">C√≥digo</div>
                    </div>
                    <div class="category-btn" data-category="examenes" onclick="selectCategory(this)">
                        <div class="icon">üìã</div>
                        <div class="name">Ex√°menes</div>
                    </div>
                    <div class="category-btn" data-category="trabajos" onclick="selectCategory(this)">
                        <div class="icon">üìÑ</div>
                        <div class="name">Trabajos</div>
                    </div>
                    <div class="category-btn" data-category="libros" onclick="selectCategory(this)">
                        <div class="icon">üìö</div>
                        <div class="name">Libros</div>
                    </div>
                    <div class="category-btn" data-category="presentaciones" onclick="selectCategory(this)">
                        <div class="icon">üéØ</div>
                        <div class="name">Presentaciones</div>
                    </div>
                    <div class="category-btn" data-category="otros" onclick="selectCategory(this)">
                        <div class="icon">üìÅ</div>
                        <div class="name">Otros</div>
                    </div>
                </div>
            </div>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <div class="upload-text">Arrastra tus archivos aqu√≠ o haz clic para seleccionar</div>
                <div class="upload-subtext">Soporta documentos, c√≥digo, im√°genes y archivos comprimidos</div>
            </div>

            <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.py,.js,.html,.css,.cpp,.c,.java,.json,.xml,.sql,.md,.yml,.yaml,.php,.rb,.go,.ts,.jsx,.tsx,.vue,.swift,.kt,.dart,.r,.m,.sh,.bat,.ps1,.csv,.zip,.rar,.7z">


            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="files-grid" id="filesGrid"></div>
        </div>
    </div>

    <script>
        // üîß CONFIGURACI√ìN DE SUPABASE - EDITA AQU√ç TUS CREDENCIALES
        const SUPABASE_CONFIG = {
            url: 'https://rdclvldnpjudgokhrasr.supabase.co', // Tu URL de Supabase
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkY2x2bGRucGp1ZGdva2hyYXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDIwNzMsImV4cCI6MjA2NDU3ODA3M30.zvHLeUzARWGjlymIBpfjfPO7fixpVcYBhlAkJjLXv5Y' // Tu clave p√∫blica (anon key)
        };

        let supabase = null;
        let selectedCategory = 'apuntes';
        let files = [];
        let debugMode = true; // Activar debug

        // Auto-conectar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('[data-category="apuntes"]').classList.add('selected');
            setTimeout(autoConnectSupabase, 1000);
        });

        // Funci√≥n de debug
        function debugLog(message, data = null) {
            if (!debugMode) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = 'block';
            
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            debugDiv.innerHTML += logEntry + '\n\n';
            debugDiv.scrollTop = debugDiv.scrollHeight;
            
            console.log(`[UniFiles Debug] ${message}`, data || '');
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        // Configurar eventos de drag and drop
        const setupDragAndDrop = () => {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        };

        async function autoConnectSupabase() {
            try {
                debugLog('Iniciando proceso de conexi√≥n...');
                updateLoadingText('Verificando configuraci√≥n...');

                // Verificar que Supabase SDK est√© cargado
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK no est√° disponible');
                }
                debugLog('‚úÖ Supabase SDK cargado correctamente');

                // Validar configuraci√≥n
                if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
                    throw new Error('Configuraci√≥n incompleta');
                }

                if (!SUPABASE_CONFIG.url.startsWith('https://') || !SUPABASE_CONFIG.url.includes('.supabase.co')) {
                    throw new Error('URL de Supabase inv√°lida');
                }

                if (!SUPABASE_CONFIG.anonKey.startsWith('eyJ') || SUPABASE_CONFIG.anonKey.length < 100) {
                    throw new Error('Clave p√∫blica inv√°lida');
                }

                debugLog('‚úÖ Configuraci√≥n v√°lida', {
                    url: SUPABASE_CONFIG.url,
                    keyLength: SUPABASE_CONFIG.anonKey.length
                });

                updateLoadingText('Conectando con Supabase...');
                
                // Inicializar cliente con timeout
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout en inicializaci√≥n')), 10000);
                });

                const initPromise = Promise.resolve().then(() => {
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    return supabase;
                });

                await Promise.race([initPromise, timeoutPromise]);
                debugLog('‚úÖ Cliente Supabase inicializado');

                updateLoadingText('Verificando conectividad...');
                
                // Test b√°sico de conectividad con timeout m√°s corto
                const connectivityTest = async () => {
                    const { data, error } = await supabase.from('files').select('count').limit(1);
                    return { data, error };
                };

                const connectivityTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout verificando conectividad')), 8000);
                });

                const { data: connectivityData, error: connectivityError } = await Promise.race([
                    connectivityTest(),
                    connectivityTimeout
                ]);

                debugLog('Test de conectividad completado', { 
                    error: connectivityError ? connectivityError.message : null,
                    data: connectivityData 
                });

                if (connectivityError) {
                    if (connectivityError.code === 'PGRST116' || connectivityError.message.includes('does not exist')) {
                        debugLog('‚ö†Ô∏è Tabla "files" no existe');
                        showTableInstructions();
                        return;
                    } else if (connectivityError.message.includes('Failed to fetch')) {
                        throw new Error('No se puede conectar al servidor. Verifica tu URL.');
                    } else if (connectivityError.message.includes('Invalid API key')) {
                        throw new Error('Clave de API inv√°lida. Verifica tu anon key.');
                    } else {
                        throw connectivityError;
                    }
                }

                debugLog('‚úÖ Conectividad verificada');
                updateLoadingText('Verificando almacenamiento...');

                // Verificar storage con timeout
                const storageTest = async () => {
                    const { data: buckets, error } = await supabase.storage.listBuckets();
                    return { buckets, error };
                };

                const storageTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout verificando storage')), 5000);
                });

                const { buckets, error: bucketsError } = await Promise.race([
                    storageTest(),
                    storageTimeout
                ]);

                if (bucketsError) {
                    debugLog('‚ö†Ô∏è Error en storage:', bucketsError);
                    // No es cr√≠tico, continuamos
                } else {
                    debugLog('‚úÖ Storage verificado', { bucketsCount: buckets?.length || 0 });
                }

                // Crear bucket si no existe
                let bucketExists = buckets?.some(bucket => bucket.name === 'university-files');
                
                if (!bucketExists) {
                    updateLoadingText('Configurando almacenamiento...');
                    debugLog('Creando bucket university-files...');
                    
                    const { error: createError } = await supabase.storage.createBucket('university-files', {
                        public: true
                    });
                    
                    if (createError && !createError.message.includes('already exists')) {
                        debugLog('‚ö†Ô∏è Advertencia creando bucket:', createError);
                    } else {
                        debugLog('‚úÖ Bucket configurado');
                    }
                }

                // ¬°Conexi√≥n exitosa!
                debugLog('üéâ Conexi√≥n completada exitosamente');
                showStatus('‚úÖ ¬°Conexi√≥n exitosa! Cargando tu biblioteca...', 'success');
                updateLoadingText('¬°Listo! Cargando interfaz...');
                
                setupDragAndDrop();
                
                setTimeout(() => {
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                    loadFiles();
                }, 2000);

            } catch (error) {
                debugLog('‚ùå Error en conexi√≥n:', error);
                console.error('Error completo:', error);
                
                let errorMessage = error.message;
                let helpText = '';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Timeout')) {
                    errorMessage = 'No se puede conectar al servidor';
                    helpText = 'Verifica que tu URL sea correcta y que el proyecto est√© activo en Supabase';
                } else if (error.message.includes('Invalid API key')) {
                    errorMessage = 'Clave de API inv√°lida';
                    helpText = 'Verifica que copiaste la clave p√∫blica (anon key) correctamente';
                } else if (error.message.includes('Project not found')) {
                    errorMessage = 'Proyecto no encontrado';
                    helpText = 'Verifica que tu URL de proyecto sea correcta';
                } else if (error.message === 'Configuraci√≥n incompleta') {
                    errorMessage = 'Configuraci√≥n incompleta';
                    helpText = 'Aseg√∫rate de configurar tanto la URL como la clave p√∫blica';
                }
                
                showStatus(`‚ùå ${errorMessage}`, 'error');
                showConfigInstructions(helpText);
            }
        }

        function showConfigInstructions(helpText = '') {
            const setupSection = document.getElementById('setupSection');
            setupSection.innerHTML = `
                <h3>üîß Configuraci√≥n de Supabase</h3>
                
                ${helpText ? `<div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 12px; padding: 15px; margin: 15px 0; color: #dc2626;">
                    <strong>üí° Sugerencia:</strong> ${helpText}
                </div>` : ''}
                
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #92400e; margin-bottom: 15px;">üìù Pasos detallados:</h4>
                    <ol style="color: #92400e; line-height: 1.8; margin-left: 20px;">
                        <li><strong>Ir a tu dashboard de Supabase:</strong> <a href="https://app.supabase.com" target="_blank" style="color: #0066cc;">app.supabase.com</a></li>
                        <li><strong>Selecciona tu proyecto</strong> (o crea uno nuevo)</li>
                        <li><strong>Ve a Settings ‚Üí API</strong> en el men√∫ lateral</li>
                        <li><strong>Copia tu Project URL</strong> (empieza con https://)</li>
                        <li><strong>Copia tu anon/public key</strong> (es MUY larga, empieza con "eyJ")</li>
                        <li><strong>Reemplaza las credenciales en el c√≥digo</strong></li>
                    </ol>
                </div>
                
                <button class="connect-btn" onclick="location.reload()" style="margin-top: 20px;">
                    üîÑ Reintentar Conexi√≥n
                </button>
                
                <div id="debugInfo" class="debug-info" style="display: block; margin-top: 20px;">
                    Informaci√≥n de debug aparecer√° aqu√≠...
                </div>
            `;
        }

        function showTableInstructions() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = `
                <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #dc2626; margin-bottom: 15px;">üóÑÔ∏è Crear Tabla Requerida</h4>
                    <p style="color: #dc2626; margin-bottom: 15px;">Ejecuta este SQL en tu Supabase (SQL Editor):</p>
                    <div style="background: #1f2937; color: #e5e7eb; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 0.9rem; overflow-x: auto;">
CREATE TABLE files (<br>
&nbsp;&nbsp;id UUID DEFAULT gen_random_uuid() PRIMARY KEY,<br>
&nbsp;&nbsp;name TEXT NOT NULL,<br>
&nbsp;&nbsp;category TEXT NOT NULL,<br>
&nbsp;&nbsp;size BIGINT NOT NULL,<br>
&nbsp;&nbsp;path TEXT NOT NULL,<br>
&nbsp;&nbsp;created_at TIMESTAMP DEFAULT NOW()<br>
);
                    </div>
                    <button class="connect-btn" onclick="location.reload()" style="margin-top: 15px;">
                        ‚úÖ Ya cre√© la tabla - Reintentar
                    </button>
                </div>
            `;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function selectCategory(element) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            selectedCategory = element.dataset.category;
        }

        async function handleFiles(fileList) {
            if (!selectedCategory) {
                alert('Por favor, selecciona una categor√≠a primero');
                return;
            }

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            
            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                const progress = ((i + 1) / fileList.length) * 100;
                progressFill.style.width = progress + '%';
                
                await uploadFile(file);
            }
            
            progressBar.style.display = 'none';
            document.getElementById('fileInput').value = '';
            loadFiles();
        }
async function uploadFile(file) {
            try {
                const fileName = `${selectedCategory}/${Date.now()}-${file.name}`;
                
                // Subir archivo al storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('university-files')
                    .upload(fileName, file);

                if (uploadError) {
                    throw uploadError;
                }

                // Guardar metadatos en la base de datos
                const { data: dbData, error: dbError } = await supabase
                    .from('files')
                    .insert([
                        {
                            name: file.name,
                            category: selectedCategory,
                            size: file.size,
                            path: fileName
                        }
                    ]);

                if (dbError) {
                    throw dbError;
                }

                debugLog(`‚úÖ Archivo subido: ${file.name}`);
                
            } catch (error) {
                debugLog(`‚ùå Error subiendo ${file.name}:`, error);
                console.error('Error:', error);
                alert(`Error subiendo ${file.name}: ${error.message}`);
            }
        }

        async function loadFiles() {
            try {
                const { data, error } = await supabase
                    .from('files')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                files = data || [];
                updateFileCount();
                renderFiles();
                
            } catch (error) {
                debugLog('‚ùå Error cargando archivos:', error);
                console.error('Error:', error);
            }
        }

        function updateFileCount() {
            document.getElementById('totalFiles').textContent = files.length;
        }

function renderFiles() {
    const filesGrid = document.getElementById('filesGrid');
    
    if (files.length === 0) {
        filesGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #6b7280;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üìÅ</div>
                <h3 style="margin-bottom: 10px; color: #374151;">No hay archivos a√∫n</h3>
                <p>Sube tus primeros archivos para comenzar a organizar tu biblioteca</p>
            </div>
        `;
        return;
    }

    filesGrid.innerHTML = files.map(file => {
        const extension = file.name.split('.').pop().toLowerCase();
        const isCodeFile = ['py', 'js', 'html', 'css', 'cpp', 'java', 'php', 'rb', 'go', 'ts', 'jsx', 'tsx'].includes(extension);
        const fileColor = getFileColor(file.name);
        
        return `
            <div class="file-card" style="border-left: 4px solid ${fileColor};">
                <div class="file-info">
                    <div class="file-icon" style="color: ${fileColor};">${getFileIcon(file.name)}</div>
                    <div class="file-details">
                        <h5>${file.name}</h5>
                        <p>${getCategoryDisplayName(file.category)} ‚Ä¢ ${formatFileSize(file.size)}</p>
                        <p style="font-size: 0.8rem; color: #9ca3af;">
                            ${new Date(file.created_at).toLocaleDateString('es-ES')}
                        </p>
                        ${isCodeFile ? `<span style="background: ${fileColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${extension.toUpperCase()}</span>` : ''}
                    </div>
                </div>
                <div class="file-actions">
                    <button class="action-btn download-btn" onclick="downloadFile('${file.path}', '${file.name}')">
                        ‚¨áÔ∏è Descargar
                    </button>
                    ${isCodeFile ? `<button class="action-btn" style="background: #8b5cf6; color: white;" onclick="previewCode('${file.path}', '${file.name}')">üëÅÔ∏è Vista</button>` : ''}
                    <button class="action-btn delete-btn" onclick="deleteFile('${file.id}', '${file.path}')">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function getFileIcon(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    const icons = {
        // Documentos
        pdf: 'üìÑ',
        doc: 'üìù',
        docx: 'üìù',
        ppt: 'üéØ',
        pptx: 'üéØ',
        xls: 'üìä',
        xlsx: 'üìä',
        txt: 'üìÑ',
        
        // Im√°genes
        jpg: 'üñºÔ∏è',
        jpeg: 'üñºÔ∏è',
        png: 'üñºÔ∏è',
        gif: 'üñºÔ∏è',
        svg: 'üñºÔ∏è',
        
        // C√≥digo Python
        py: 'üêç',
        
        // C√≥digo Web
        html: 'üåê',
        css: 'üé®',
        js: '‚ö°',
        jsx: '‚öõÔ∏è',
        tsx: '‚öõÔ∏è',
        vue: 'üíö',
        
        // C√≥digo Backend
        php: 'üêò',
        java: '‚òï',
        cpp: '‚öôÔ∏è',
        c: '‚öôÔ∏è',
        cs: 'üî∑',
        rb: 'üíé',
        go: 'üêπ',
        rs: 'ü¶Ä',
        swift: 'üçé',
        kt: 'ü§ñ',
        dart: 'üéØ',
        
        // Bases de datos
        sql: 'üóÑÔ∏è',
        
        // Configuraci√≥n y datos
        json: 'üìã',
        xml: 'üìã',
        yml: '‚öôÔ∏è',
        yaml: '‚öôÔ∏è',
        csv: 'üìä',
        
        // Scripts
        sh: '‚å®Ô∏è',
        bat: '‚å®Ô∏è',
        ps1: 'üíô',
        
        // Documentaci√≥n
        md: 'üìñ',
        
        // Archivos comprimidos
        zip: 'üì¶',
        rar: 'üì¶',
        '7z': 'üì¶',
        tar: 'üì¶',
        gz: 'üì¶',
        
        // Otros
        r: 'üìà',
        m: 'üî¢',
        ts: 'üî∑'
    };
    return icons[extension] || 'üìÅ';
}

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function downloadFile(filePath, fileName) {
            try {
                const { data, error } = await supabase.storage
                    .from('university-files')
                    .download(filePath);

                if (error) {
                    throw error;
                }

                // Crear URL para descarga
                const url = URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                debugLog(`‚ùå Error descargando ${fileName}:`, error);
                alert(`Error descargando el archivo: ${error.message}`);
            }
        }

        async function deleteFile(fileId, filePath) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este archivo?')) {
                return;
            }

            try {
                // Eliminar de storage
                const { error: storageError } = await supabase.storage
                    .from('university-files')
                    .remove([filePath]);

                if (storageError) {
                    debugLog('‚ö†Ô∏è Error eliminando de storage:', storageError);
                }

                // Eliminar de base de datos
                const { error: dbError } = await supabase
                    .from('files')
                    .delete()
                    .eq('id', fileId);

                if (dbError) {
                    throw dbError;
                }

                debugLog(`‚úÖ Archivo eliminado: ${filePath}`);
                loadFiles();
                
            } catch (error) {
                debugLog(`‚ùå Error eliminando archivo:`, error);
                alert(`Error eliminando el archivo: ${error.message}`);
            }
        }
    </script>
    <script>
        function getFileColor(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    const colors = {
        // Python
        py: '#3776ab',
        
        // Web
        html: '#e34c26',
        css: '#1572b6',
        js: '#f7df1e',
        jsx: '#61dafb',
        tsx: '#61dafb',
        vue: '#4fc08d',
        
        // Backend
        php: '#777bb4',
        java: '#ed8b00',
        cpp: '#00599c',
        c: '#a8b9cc',
        cs: '#239120',
        rb: '#cc342d',
        go: '#00add8',
        swift: '#fa7343',
        
        // Base de datos
        sql: '#336791',
        
        // Otros
        json: '#292929',
        md: '#083fa1',
        sh: '#89e051'
    };
    return colors[extension] || '#667eea';
}
function getCategoryDisplayName(category) {
    const names = {
        'apuntes': 'Apuntes',
        'examenes': 'Ex√°menes',
        'trabajos': 'Trabajos',
        'libros': 'Libros',
        'presentaciones': 'Presentaciones',
        'codigo': 'C√≥digo',
        'otros': 'Otros'
    };
    return names[category] || category;
}

    </script>
    <script>
        
    </script>
</body>
</html>